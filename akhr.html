<!DOCTYPE html>

<html lang="zh-Hans" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Arknights Recruitment Calculator</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <script src="js/jquery-3.4.0.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-138420636-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-138420636-1');
    </script>
    <style>
        .nopadding {
            padding: 0 !important;
            margin: 0 !important;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .tagMod{
            width: fit-content;
            display: inline-block;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a class="navbar-brand" href="#">Arknights Toolbox</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="展开">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="akhr.html">Recruitment Calculator</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="akhrchars.html">Operators Table</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="aklevel.html">Leveling Calculator</a>
                </li>
                <li class="nav-item">
                        <a class="nav-link" href="akguide.html">Guide</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled" href="#">WIP</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="col-md-12 col-sm-12" style="margin:auto;max-width:1000px;">
        <div class="row"style="padding:0">
            <div class="col-12">
                <div class="form-group col-xs-6" style="margin: unset; padding-top: 17px; float: right; padding-left: 10px;">
                    <label for="selLang">Translate to: </label>
                    <select style="width: fit-content; display: inline-block; height: 30px; padding-top: 0px;" class="form-control" id="selLang" onchange="changeUILanguage()">
                        <option value="en">English</option>
                        <option value="cn">Chinese</option>
                        <option value="jp">Japanese</option>
                    </select>
                </div>
                <div class="form-group col-xs-6" style="margin: unset; padding-top: 17px; float: right;">
                    <label for="selReg">Game Server: </label>
                    <select style="width: fit-content; display: inline-block; height: 30px; padding-top: 0px;" class="form-control" id="selReg" onchange="changeUILanguage()">
                        <option value="cn">CN</option>
                        <!--<option value="jp">JP</option>-->
                    </select>
                </div>
            </div>
        </div>
        <div class="col-12 alert alert-dark mt-3" role="alert">
            <!-- <div class="row">
                    <div class="col-12 btn btn-sm btn-success  disabled ">Select the tags :</div>
            </div> -->
            <div class="row">
                    <div class="col-md-2 col-sm-12 btn btn-sm btn-info my-1 disabled "style="padding-right:0">Qualification 资质 </div>
                <div class= "col-md-10 col-sm-12">
                        <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-qualifications button-tag" data-toggle="tooltip" data-placement="top" title="Newbie" cn-text="新手">新手</button>
                        <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-qualifications button-tag" data-toggle="tooltip" data-placement="top" title="Senior" cn-text="资深干员">资深干员</button>
                        <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-qualifications button-tag" data-toggle="tooltip" data-placement="top" title="Advanced Senior" cn-text="高级资深干员">高级资深干员</button>
                </div>
            </div>
            <div class="row">
                    <div class="col-md-2 col-sm-12 btn btn-sm btn-info my-1 disabled "style="padding-right:0">
                            Position 位置
                    </div>
                    <div class= "col-md-10 col-sm-12">
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-position button-tag" data-toggle="tooltip" data-placement="top" title="Melee" cn-text="近战位">近战位</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-position button-tag" data-toggle="tooltip" data-placement="top" title="Ranged" cn-text="远程位">远程位</button>
                    </div>
            </div>
            <div class="row">
                    <div class="col-md-2 col-sm-12 btn btn-sm btn-info my-1 disabled ">
                            Gender 位置
                    </div>
                    <div class= "col-md-10 col-sm-12 span">
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-gender button-tag" data-toggle="tooltip" data-placement="top" title="Female" cn-text="女性干员">女性干员</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-gender button-tag" data-toggle="tooltip" data-placement="top" title="Male" cn-text="男性干员">男性干员</button>
                        </div>
            </div>
            <div class="row">
                    <div class="col-md-2 col-sm-12 btn btn-sm btn-info my-1 disabled ">
                            Class 种类
                    </div>
                    <div class= "col-md-10 col-sm-12 span">
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-class button-tag" data-toggle="tooltip" data-placement="top" title="Guard" cn-text="近卫">近卫</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-class button-tag" data-toggle="tooltip" data-placement="top" title="Medic" cn-text="医疗">医疗</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-class button-tag" data-toggle="tooltip" data-placement="top" title="Vanguard" cn-text="先锋">先锋</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-class button-tag" data-toggle="tooltip" data-placement="top" title="Caster" cn-text="术师">术师</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-class button-tag" data-toggle="tooltip" data-placement="top" title="Sniper" cn-text="狙击">狙击</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-class button-tag" data-toggle="tooltip" data-placement="top" title="Defender" cn-text="重装">重装</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-class button-tag" data-toggle="tooltip" data-placement="top" title="Support" cn-text="辅助">辅助</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-class button-tag" data-toggle="tooltip" data-placement="top" title="Specialist" cn-text="特种">特种</button>
                    </div>
            </div>
            <div class="row">
                    <div class="col-md-2 col-sm-12 btn btn-sm btn-info my-1 disabled">
                            Affix 词缀
                    </div>
                    <div class= "col-md-10 col-sm-12 span">
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Healing" cn-text="治疗">治疗</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Support" cn-text="支援">支援</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="DPS" cn-text="输出">输出</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Splash" cn-text="群攻">群攻</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Slow" cn-text="减速">减速</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Survival" cn-text="生存">生存</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Protection" cn-text="防护">防护</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Debuffer" cn-text="削弱">削弱</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Displacement" cn-text="位移">位移</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Crowd Control" cn-text="控场">控场</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Burst" cn-text="爆发">爆发</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Summoner" cn-text="召唤">召唤</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Quick Resurrection" cn-text="快速复活">快速复活</button>
                            <button type="button" onclick="clickBtnTag(this)" class="btn btn-sm btn-secondary btn-tag my-1 tags-affix button-tag" data-toggle="tooltip" data-placement="top" title="Cost Recovery" cn-text="费用回复">费用回复</button>        
                    </div>
            </div>
            <div class="row">
                    <div class="col-md-2 col-sm-12 btn btn-sm btn-info my-1 disabled">
                            Filter Rarity
                    </div>
                    <div class= "col-md-10 col-sm-12 span">
                            <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1 button-tag" opt-id="all" id="opt-all">ALL</button>
                            <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1 button-tag" opt-id="6">6★</button>
                            <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1 button-tag" opt-id="5">5★</button>
                            <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1 button-tag" opt-id="4">4★</button>
                            <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1 button-tag" opt-id="3">3★</button>
                            <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1 button-tag" opt-id="2">2★</button>
                            <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1 button-tag" opt-id="1">1★</button>
                    </div>
            </div>
            <div class="row">
                    <div class="col-md-2 col-sm-12 btn btn-sm btn-info my-1 disabled">
                            Show
                    </div>
                    <div class= "col-md-10 col-sm-12 span">
                            <button type="button" onclick="clickBtnOpt2(this)" class="btn btn-sm btn-primary my-1 btn-name" id="showName" opt-id="showName">Name</button>
                            <button type="button" onclick="clickBtnOpt2(this)" class="btn btn-sm btn-primary my-1 btn-image" id="showImage" opt-id="showImage">Image</button>
                            <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="position: absolute; margin-left: 5px; margin-top: 4px; z-index: 1;">
                            Image Size
                            </button>
                            <button type="button" class="btn btn-sm btn-primary my-1 btn-image"  style="background-color: white; color: black; border-color: darkgrey; width: fit-content; position: absolute; margin-left: 100px; padding-left: 10px;" disabled>Selected: <span id="selectedImageSize"></span></button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                <button class="dropdown-item btn-size imagesizeselect" onclick="changeImageSize(this)" id="btn-calculate" type="button" title="20">20</button>
                                <button class="dropdown-item btn-size imagesizeselect" onclick="changeImageSize(this)" id="btn-calculate" type="button" title="32">32</button>
                                <button class="dropdown-item btn-size imagesizeselect" onclick="changeImageSize(this)" id="btn-calculate" type="button" title="40">40</button>
                                <button class="dropdown-item btn-size imagesizeselect" onclick="changeImageSize(this)" id="btn-calculate" type="button" title="64">64</button>
                                <button class="dropdown-item btn-size imagesizeselect" onclick="changeImageSize(this)" id="btn-calculate" type="button" title="80">80</button>
                                <button class="dropdown-item btn-size imagesizeselect" onclick="changeImageSize(this)" id="btn-calculate" type="button" title="128">128</button>
                            </div>
                    </div>
            </div>
            <div class="row">
                    <button class="btn btn-danger col-12 align-self-center text-center" style="padding:1px" id="btn-clear" onclick="clickBtnClear()">Clear</button>
            </div>
            <!-- <table >
                <tr>
                    <td colspan=4><hr class="my-1" /></td>
                </tr>
                <tr style="text-align:left;vertical-align:top;padding:0">
                    <td colspan=2><button style="width:100%" type="button" class="btn btn-sm btn-info my-1" disabled>Filter Rarity</button></td>
                    <td>
                        <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1" opt-id="all" id="opt-all">ALL</button>
                        <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1" opt-id="6">6★</button>
                        <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1" opt-id="5">5★</button>
                        <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1" opt-id="4">4★</button>
                        <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1" opt-id="3">3★</button>
                        <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1" opt-id="2">2★</button>
                        <button type="button" onclick="clickBtnOpt(this)" class="btn btn-sm btn-primary btn-opt my-1" opt-id="1">1★</button></td>
                </tr>
                <tr style="text-align:left;vertical-align:top;padding:0">
                    <td colspan=2><button style="width:100%" type="button"id="btn-calculate" class="btn btn-sm btn-info my-1" disabled>Show</button></td>
                    <td>
                        <button type="button" onclick="clickBtnOpt2(this)" class="btn btn-sm btn-primary my-1 btn-name" id="showName" opt-id="showName">Name</button>
                        <button type="button" onclick="clickBtnOpt2(this)" class="btn btn-sm btn-primary my-1 btn-image" id="showImage" opt-id="showImage">Image</button>
                        <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="position: absolute; margin-left: 5px; margin-top: 4px; z-index: 1;">
                        Image Size
                        </button>
                        <button type="button" class="btn btn-sm btn-primary my-1 btn-image"  style="background-color: white; color: black; border-color: darkgrey; width: fit-content; position: absolute; margin-left: 100px; padding-left: 10px;" disabled>Selected: <span id="selectedImageSize"></span></button>
                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <button class="dropdown-item btn-size imagesizeselect" onclick="changeImageSize(this)" id="btn-calculate" type="button" title="20">20</button>
                            <button class="dropdown-item btn-size imagesizeselect" onclick="changeImageSize(this)" id="btn-calculate" type="button" title="32">32</button>
                            <button class="dropdown-item btn-size imagesizeselect" onclick="changeImageSize(this)" id="btn-calculate" type="button" title="40">40</button>
                            <button class="dropdown-item btn-size imagesizeselect" onclick="changeImageSize(this)" id="btn-calculate" type="button" title="64">64</button>
                            <button class="dropdown-item btn-size imagesizeselect" onclick="changeImageSize(this)" id="btn-calculate" type="button" title="80">80</button>
                            <button class="dropdown-item btn-size imagesizeselect" onclick="changeImageSize(this)" id="btn-calculate" type="button" title="128">128</button>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-danger col-12 align-self-center text-center" id="btn-clear" onclick="clickBtnClear()">Clear</button>
                    </td>
                </tr>
            </table> -->
        <!-- </div> -->
        <div id="box-options">  
        </div>
    </div>
        <table class="table table-striped table-hover my-3" id="table-recommend">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col" style="width:16.67%">Tags</th>
                    <th scope="col">Character Possibility</th>
                    
                </tr>
            </thead>
            <tbody id="tbody-recommend"></tbody>
        </table>
        <hr />
        <div class="row col-12 tutorial">
            <div class="col-12 text-left">
                <p>How To Use ：</p>
                <p>1. Change the 'Game Server' drop down on the top right according to your AK client region.</p>
                <p>2. Change the language of the user interface to your preference.</p>
                <p>3. Click on the tags, up to 6 tags.</p>
                <p>4. You can hover on the tags to see the translation.</p>
                <p>5. You can also hide or show the name and/or the image of the operators.</p>
                <p>6. Click 'clear' to reset all the tag selections.</p>
            </div>
        </div>
    </div>

    <hr />
    <div class="row col-12 page-footer">
        <div class="col-12 text-center">
            <p>Forked from <a href = "https://graueneko.github.io/akhr.html">grauneko web</a></p>
            <p>最近更新：2019/05/02，<a href="https://bbs.nga.cn/read.php?tid=16971344">联系作者</a></p>
            <p>
                数据来源：
                <a href="http://wiki.joyme.com/arknights/%E5%B9%B2%E5%91%98%E6%95%B0%E6%8D%AE%E8%A1%A8">明日方舟Wiki</a>
            </p>
            <p>Powered by 一只灰猫。</p>

        </div>
    </div>
    <script>
        $(function () {
            $('.dropdown-trigger').dropdown();
            $('[data-toggle="tooltip"]').tooltip();


            if(localStorage.getItem('showImage') === null){
                localStorage.setItem("showImage", "true");
                localStorage.setItem("showName", "true");
                localStorage.setItem("size", 40);
            } else {
                if(localStorage.showName == 'false'){
                    $("#showName").toggleClass("btn-primary btn-secondary");
                }
                if(localStorage.showImage == 'false'){
                    $("#showImage").toggleClass("btn-primary btn-secondary");
                }
            }

            if(typeof localStorage.gameRegion === "undefined"){
                console.log("game region undefined");
                localStorage.setItem("gameRegion", 'cn');
                localStorage.setItem("webLang", 'en');
                $("#selReg").val('cn');
                $("#selLang").val('en');
            } else {
                console.log(localStorage.gameRegion);
                $("#selReg").val(localStorage.gameRegion);
                $("#selLang").val(localStorage.webLang);
            }
            changeUILanguage();

            console.log("Show Name: ");
            console.log(localStorage.showName);
            console.log("Show Image: ");
            console.log(localStorage.showImage);

            let lastChar = ""
            $(document).on("click", ".button-tag", function () {
                lastChar = ""
            });

            $(document).on("click", ".btn-name", function () {
                if(localStorage.getItem('showName') == 'false'){
                    localStorage.setItem('showName','true');
                } else {
                    localStorage.setItem('showName','false');
                }
                console.log("Show Name: ");
                console.log(localStorage.getItem('showName'));
            })
            $(document).on("click", ".btn-image", function () {
                if(localStorage.getItem('showImage') == 'false'){
                    localStorage.showImage = 'true';
                } else {
                    localStorage.showImage = 'false';
                }
                console.log("Show Image: ");
                console.log(localStorage.getItem('showImage'));
            });
        });

        //var global = this;

        var JsonDATA = [];
        
            
        var checkedTags = [];
        var checkedTagsTL = [];
        var globalOptStars = [];

        function showChar(el){
            var reg = $("#selReg").val();
            var lang = $("#selLang").val();
            let all_chars = JsonDATA[1];
            let all_tags = JsonDATA[3];
            let all_types = JsonDATA[4];
            let char_name = $(el).attr('data-original-title');
            //console.log(all_tags);
            //console.log(all_chars);
            console.log("char name: "+char_name);
            $(".tr-recommd").show();
            $(".tr-chartag").remove();
            if (localStorage.lastChar != char_name) {
                $(".tr-recommd:not(:contains('" + $(el).text() + "'))").hide();
                let char = all_chars[char_name];
                let colors = { 1: "dark", 2: "light", 3: "success", 4: "info", 5: "warning", 6: "danger" };
                //console.log(char)
                let tags_html = [];
                $.each(char.tags, function (_, tag) {
                    var tagReg;
                    var tagTL;
                    var found = false;
                    $.each(all_tags, function(_, alltag){
                        console.log(alltag);
                        console.log(tag);
                        if(alltag.tag_cn == tag){
                            tagReg = eval('alltag.tag_'+reg);
                            tagTL = eval('alltag.tag_'+lang);
                            found = true;
                            return false;
                        }
                    });
                    if(!found){
                        $.each(all_types, function(_, alltypes){
                            if(alltypes.type_cn == tag){
                                tagReg = eval('alltypes.type_'+reg);
                                tagTL = eval('alltypes.type_'+lang);
                                found = true;
                                return false;
                            }
                        })
                    }
                    if(found){
                        tags_html.push("<button type=\"button\" class=\"btn btn-sm btn-secondary btn-char my-1\" data-toggle=\"tooltip\" data-placement=\"top\" title=\""+ tagReg +"\">" +
                        tagTL + "</button>\n")
                    }
                });
                
                $("#tbody-recommend").append(
                    "<tr class=\"tr-chartag\"><td>#</td><td>" +
                    "<button type=\"button\" class=\"btn btn-sm btn-" + colors[char.level] +
                    " btn-char my-1\" data-toggle=\"tooltip\" data-placement=\"right\" title=\""+ eval("char.name_"+reg) +"\" onclick=\"showChar(this)\">" + eval("char.name_"+lang) + "</button>\n" +
                    "</td><td>" + tags_html.join("") +
                    "</td><td>#</td></tr>"
                );

                $('[data-toggle="tooltip"]').tooltip();
                localStorage.lastChar = char_name
            }else{
                $(".tr-chartag").remove();
                localStorage.lastChar = ""
                // setTimeout(function(){
                //     showChar(el);
                // }, 200);
            }
        }
        
        function clickBtnClear(){
            $('.btn-tag').removeClass('btn-primary').addClass('btn-secondary');
            $("#tbody-recommend").html("");
            checkedTags = [];
            checkedTagsTL = [];
            localStorage.lastChar = ""
        }

        function changeImageSize(el){
            localStorage.size = parseInt($(el).attr('title'));
            console.log("image size = "+localStorage.size);
            $("#selectedImageSize").html(localStorage.size);
            $(".imagesizeselect").each(function(){
                let size = localStorage.size;
                if($(this).attr("title") == size){
                    $("<span> <<</span>").appendTo(this);
                } else {
                    $(this).html($(this).attr("title"));
                }
            });
            refresh();
        }

        function clickBtnOpt(el){
            $(el).toggleClass("btn-primary btn-secondary");
            let checked = $(el).hasClass("btn-primary");
            if ($(el).attr("id") === "opt-all") {
                $(".btn-opt").removeClass("btn-primary btn-secondary").addClass(
                    checked ? "btn-primary" : "btn-secondary"
                );
            } else {
                if ($("#opt-all").hasClass("btn-primary")) {
                    $("#opt-all").toggleClass("btn-primary btn-secondary");
                } else {
                    let checkedCount = 0;
                    $(".btn-opt").each(function (_, __) {
                        if ($(el).attr("id") === "opt-all") return;
                        if ($(el).hasClass("btn-primary")) checkedCount++;
                    });
                    console.log("checked count:");
                    console.log(checkedCount);
                    if (checkedCount === 7) $("#opt-all").toggleClass("btn-primary btn-secondary");
                }
            }
            globalOptStars = [];
            $(".btn-opt").each(function (_, __) {
                if ($(this).attr("opt-id") === "all" || $(this).hasClass("btn-secondary")) return;
                globalOptStars.push($(this).attr("opt-id"));
            });
            console.log("opstars:")
            console.log(globalOptStars);

            refresh();
        }

        function clickBtnOpt2(el){
            $(el).toggleClass("btn-primary btn-secondary");
            localStorage.lastChar = ""
            refresh();
        }

        function clickBtnTag(el){
            let checked = $(el).hasClass("btn-primary");
            let tag = $(el).attr('cn-text');
            let tagTL = $(el).attr('data-original-title');
            if (checked) {
                checkedTags = checkedTags.filter(function (v, _, __) {
                    return v !== tag;
                });
                checkedTagsTL = checkedTagsTL.filter(function (v, _, __) {
                    return v !== tagTL;
                });
            } else {
                if (checkedTags.length >= 6) {
                    alert("Only 6 tags max");
                    return;
                } else {
                    checkedTags.push(tag);
                    checkedTagsTL.push(tagTL);
                }
            }
            $(el).toggleClass("btn-primary btn-secondary");
            localStorage.lastChar = ""
            // console.log(checkedTags);
            // console.log(checkedTagsTL);
            // console.log(tag)
            refresh();
        }

        function calculate(){
            if(typeof checkedTags !== 'undefined'){
                //console.log(JsonDATA);
                let tags_aval = JsonDATA[0];
                let all_chars = JsonDATA[1];
                let avg_char_tag = JsonDATA[2];
                let len = checkedTags.length;
                let count = Math.pow(2, checkedTags.length);
                let combs = [];
                for (let i = 0; i < count; i++) {
                    let ts = [];
                    let tstl = [];
                    for (let j = 0, mask = 1; j < len; j++) {
                        if ((i & mask) !== 0) {
                            ts.push(checkedTags[j]);
                            tstl.push(checkedTagsTL[j]);
                            // console.log(checkedTags[j]);
                        }
                        mask = mask * 2;
                    }
                    combs.push({ "tags": ts, "tagsTL": tstl, "score": 0.0, "possible": [] });
                }
                // console.log(combs);
                $("#tbody-recommend").html("");
                $.each(combs, function (_, comb) {
                    let tags = comb.tags;
                    if (tags.length === 0 || tags.length > 3) return;
                    let chars = [...tags_aval[tags[0]]];
                    for (let i = 1; i < tags.length; i++) {
                        let reduced_chars = [];
                        $.each(chars, function (_, char) {
                            // console.log(tags_aval[tags[i]]);
                            // console.log(char);
                            $.each(tags_aval[tags[i]], function (_, tgch) {
                                if (char.name === tgch.name) {
                                    reduced_chars.push(char);
                                    return false;
                                }
                            });
                        });
                        chars = reduced_chars;
                    }

                    let optStars = globalOptStars;
                    if(optStars.length == 0 ){
                        $(".btn-opt").each(function (_, __) {
                            if ($(this).attr("opt-id") === "all" || $(this).hasClass("btn-secondary")) return;
                            optStars.push($(this).attr("opt-id"));
                        });
                    }

                    if (chars.length === 0) return;
                    if (!tags.includes("资深干员") && !tags.includes("高级资深干员")) {
                        // console.log(tags.join(",") + " 不含(高级)资深干员");
                        let reduce6 = [];
                        $.each(chars, function (_, char) {
                            if (char.level !== 6) {
                                reduce6.push(char);
                            }
                        });
                        chars = reduce6;
                    }
                    let filtered_chars = [];
                    $.each(chars, function (_, char) {
                        //console.log(char.level);
                        if (optStars.includes(char.level.toString())) {
                            filtered_chars.push(char);
                        }
                    });
                    chars = filtered_chars;

                    comb.possible = chars;
                    if (chars.length === 0) return;
                    let s = 0;
                    $.each(chars, (_, char) => {
                        s += char.level;
                    });
                    s = s / chars.length;
                    comb.score = s - tags.length / 10 - chars.length / avg_char_tag;
                    //console.log("tags length = "+tags.length);
                    //console.log("chars length = "+chars.length);
                    console.log("avg char tag = "+avg_char_tag);
                    //console.log("score = "+comb.score);
                });
                combs.sort(function (a, b) {
                    return a.score > b.score ? -1 : (a.score < b.score ? 1 :
                        (a.tags.length > b.tags.length ? 1 : (a.tags.length < b.tags.length ? -1 : 0)));
                });
                let no = 1;
                $.each(combs, function (_, comb) {
                    if (comb.possible.length === 0) return;
                    let chars = comb.possible;
                    let tags = comb.tags;
                    let tagsTL = comb.tagsTL
                    let chars_html = [];
                    let colors = { 1: "dark", 2: "light", 3: "success", 4: "info", 5: "warning", 6: "danger" };
                    comb.possible.sort(function (a, b) {
                        return a.level > b.level ? -1 : (a.level < b.level ? 1 : 0);
                    });
                    $.each(chars, function (_, char) {
                        let padding = localStorage.showName=='true' && localStorage.size <60? "padding-right: 8px" : "padding-right: 1px";
                        let style = localStorage.showImage=='true' ? "style=\"border-radius: 5px;padding: 1px 1px;" + padding + ";\" " : "";
                        let buttonstyle = localStorage.size >25? "background-color: #AAA;border-radius: 4px;": "background-color: transparent;border-radius: 4px;";
                        chars_html.push("<button type=\"button\" class=\"btn btn-sm btn-" + colors[char.level] + " btn-char my-1\" data-toggle=\"tooltip\" data-placement=\"bottom\" onclick=\"showChar(this)\" " +style+"title=\""+ char.name +"\">");
                        if(localStorage.showImage == 'true')chars_html.push("<img style=\""+buttonstyle+"\"height=\""+localStorage.size+"\" width=\""+localStorage.size+"\" src=\"./img/chara/"+ char.name_en +".png\">   " )
                        if(localStorage.size>60)chars_html.push("<div>")
                        if(localStorage.showName == 'true')chars_html.push(char.name_tl)
                        if(localStorage.size>60)chars_html.push("</div>")
                        chars_html.push("</button>\n")
                    });
                    let tags_html = [];
                    $.each(tags, function (_, tag) {
                        tags_html.push("<button type=\"button\" class=\"btn btn-sm btn-secondary btn-char my-1\">" +
                            tag + "</button>\n")
                    });
                    let tagsTL_html = [];
                    $.each(tagsTL, function (i, tagTL) {
                        tagsTL_html.push("<button type=\"button\" class=\"btn btn-sm btn-secondary btn-char my-1\" data-toggle=\"tooltip\" data-placement=\"right\" title=\""+ tags[i] +"\">" +
                            tagTL + "</button>\n")
                    });
                    $("#tbody-recommend").append(
                        "<tr class=\"tr-recommd\"><td>" + no++ + "</td><td>" + tagsTL_html.join("") + "</td><td>" + chars_html.join("") +
                        "</td>"+""+"</tr>"
                    );
                    $('[data-toggle="tooltip"]').tooltip();
                });
            }
        }

        function loadJson(){
            let tags_aval = {};
            let all_chars = {};
            let avg_char_tag = 0;
            $.getJSON("json/tl-akhr.json", function (data) {
                let tag_count = 0;
                let char_tag_sum = 0;
                // console.log(data);
                $.each(data, function (_, char) {
                    var reg = $("#selReg").val();
                    var lang = $("#selLang").val();
                    if (char.hidden) return;
                    char.tags.push(char.type);
                    if($("#selReg").val() == 'cn'){
                        char.tags.push(char.sex + "性干员");
                    } else {
                        char.tags.push(char.sex);
                    }
                    $.each(char.tags, function (_, tag) {
                        if (tag in tags_aval) {
                            tags_aval[tag].push({ 
                                "name_en": char.name_en, 
                                "name": eval('char.name_'+reg),
                                "name_tl": eval('char.name_'+lang),
                                "level": char.level, 
                                "type": char.type });
                        } else {
                            tags_aval[tag] = [{ 
                                "name_en": char.name_en, 
                                "name": eval('char.name_'+reg), 
                                "name_tl": eval('char.name_'+lang),
                                "level": char.level, 
                                "type": char.type }];
                        }
                        char_tag_sum++;
                    });
                    all_chars[char.name_cn] = { 'name_cn': char.name_cn, 'name_en': char.name_en, 'name_jp': char.name_jp, 'name_kr': char.name_kr, 'level': char.level, 'tags': char.tags };
                });
                //$.each(tags_aval, function (key, _) {
                //    $("#box-tags").append(
                //        "<button type=\"button\" class=\"btn btn-sm btn-secondary btn-tag my-1\">" + key + "</button>\n"
                //    );
                //    tag_count++;
                //});
                //console.log(avg_char_tag);
                tag_count = Object.keys(tags_aval).length;
                avg_char_tag = char_tag_sum / tag_count;

                JsonDATA[0] = tags_aval;
                JsonDATA[1] = all_chars;
                JsonDATA[2] = avg_char_tag;
            });
            var data1, data2;
            $.when(
                $.getJSON("json/tl-tags.json", function (data){
                    data1 = data;
                }),
                $.getJSON("json/tl-type.json", function (data){
                    data2 = data;
                })
            ).then(function(){
                if(data1){
                    if(data2){
                        JsonDATA[3] = data1;
                        JsonDATA[4] = data2;
                    }
                }
            });
        }

        function changeUILanguage(){
            localStorage.setItem("gameRegion", $("#selReg").val());
            localStorage.setItem("webLang", $("#selLang").val());
            let reg = $("#selReg").val();
            let lang = $("#selLang").val();
            let types = ["qualifications","position","affix"];
            for (let m = 0; m < types.length; m++) {
                $(".tags-"+types[m]).each(function(j,el){
                    getJSONdata("tags",function(data){
                        if(data.length != 0){
                            let k = 0;
                            for (var i = 0; i < data.length; i++) {
                                if(data[i].type == types[m]){
                                    //console.log("j="+j+" , k="+k);
                                    if(j==k){
                                        $(el).html(eval("data[i].tag_"+reg));
                                        $(el).attr("data-original-title", eval("data[i].tag_"+lang));
                                    }
                                    k++;
                                }
                            }
                        }
                    });
                });
            }
            $(".tags-gender").each(function(i,el){
                getJSONdata("gender",function(data){
                    if(data.length != 0){
                        if(reg == 'cn'){
                            $(el).html(eval("data[i].sex_"+reg)+'性干员');
                        } else {
                            $(el).html(eval("data[i].sex_"+reg));
                        }
                        $(el).attr("data-original-title", eval("data[i].sex_"+lang));
                    }
                });
            });
            $(".tags-class").each(function(i,el){
                getJSONdata("type",function(data){
                    if(data.length != 0){
                        $(el).html(eval("data[i].type_"+reg));
                        $(el).attr("data-original-title", eval("data[i].type_"+lang));
                    }
                });
            });
            checkedTags = [];
            checkedTagsTL = [];
            //refresh();
            $(".btn-tag.btn-primary").each(function(_,el){
                doubleclick(el);
            });
        }

        function getJSONdata(type, callback){
            var x = 0;
            var req = $.getJSON("json/tl-"+type+".json");
            req.done(function(response){
                callback(response);
            });
            
        }

        function doubleclick(el){
            setTimeout(function(){
                $(el).click();
            }, 200);
            $(el).click();
        }

        function refresh(){
            setTimeout(function(){
                setTimeout(function(){
                    calculate();
                }, 200);
                calculate();
            }, 200);
            loadJson();
        }
    </script>
</body>
</html>
<!DOCTYPE html>

<html lang="zh-Hans" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>明日方舟等级消耗计算器</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/jquery-3.4.0.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-138420636-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-138420636-1');
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a class="navbar-brand" href="#">明日方舟工具箱</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="展开">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="akhr.html">公开招募计算器</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="akhrchars.html">干员表</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="aklevel.html">升级计算</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled" href="#">施工中…</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="container col-12 col-sm-10 col-md-8 col-lg-6" style="margin:auto;">
        <div class="alert alert-dark mt-3 px-3 px-sm-4 form-control-sm">
            <div class="form-row">
                <div class="form-group col-12 col-sm-2">
                    <label for="star">星级★</label>
                    <select id="star" class="form-control form-control-sm">
                        <option selected>6</option>
                        <option>5</option>
                        <option>4</option>
                        <option>3</option>
                        <option>2</option>
                        <option>1</option>
                    </select>
                </div>
                <div class="form-group col-6 col-sm-5">
                    <label for="lslevel">经验本</label>
                    <select id="lslevel" class="form-control form-control-sm">
                        <option selected>LS-5</option>
                        <!--<option>LS-4</option>
                        <option>LS-3</option>
                        <option>LS-2</option>
                        <option>LS-1</option>-->
                    </select>
                </div>
                <div class="form-group col-6 col-sm-5">
                    <label for="lslevel">金币本</label>
                    <select id="lslevel" class="form-control form-control-sm">
                        <option selected>CE-5</option>
                        <!--<option>CE-4</option>
                        <option>CE-3</option>
                        <option>CE-2</option>
                        <option>CE-1</option>-->
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-4">
                    <label for="current-evolve">当前精英化</label>
                    <select id="current-evolve" class="form-control form-control-sm">
                        <option selected>0</option>
                        <option>1</option>
                        <option>2</option>
                    </select>
                </div>
                <div class="form-group col-4">
                    <label for="current-level">当前等级</label>
                    <input type="text" class="form-control form-control-sm" id="current-level" value="1">
                </div>
                <div class="form-group col-4">
                    <label for="current-exp">当前经验</label>
                    <input type="text" class="form-control form-control-sm" id="current-exp" value="0">
                </div>
                <div class="form-group col-4">
                    <label for="target-evolve">目标精英化</label>
                    <select id="target-evolve" class="form-control form-control-sm">
                        <option selected>0</option>
                        <option>1</option>
                        <option>2</option>
                    </select>
                </div>
                <div class="form-group col-4">
                    <label for="target-level">目标等级</label>
                    <input type="text" class="form-control form-control-sm" id="target-level" value="1">
                </div>
                <div class="form-group col-4">
                    <label for="gold-asset">已有金币</label>
                    <input type="text" class="form-control form-control-sm" id="gold-asset" value="0">
                </div>
                <div class="form-group col-3">
                    <label for="book-basic">基础经验</label>
                    <input type="text" class="form-control form-control-sm" id="book-basic" value="0">
                </div>
                <div class="form-group col-3">
                    <label for="book-primary">初级经验</label>
                    <input type="text" class="form-control form-control-sm" id="book-primary" value="0">
                </div>
                <div class="form-group col-3">
                    <label for="book-middle">中级经验</label>
                    <input type="text" class="form-control form-control-sm" id="book-middle" value="0">
                </div>
                <div class="form-group col-3">
                    <label for="book-advanced">高级经验</label>
                    <input type="text" class="form-control form-control-sm" id="book-advanced" value="0">
                </div>
            </div>
        </div>
        <div class="row col-12">
            <div class="col-12">
                <button class="btn btn-success col-12 align-self-center text-center" id="btn-calculate">计算</button>
            </div>
        </div>
        <div class="col-12 alert alert-danger mt-3" id="error-info" role="alert" style="display:none">

        </div>
        <div class="row rounded">
            <table class="table table-striped my-3">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col" width="40%" class="text-right">资源</th>
                        <th scope="col" width="60%">需求</th>
                    </tr>
                </thead>
                <tbody id="tbody-result"></tbody>
            </table>
        </div>
        <hr />
        <div class="row col-12 tutorial">
            <div class="col-12 col-sm-6 text-left">
                <p><b>各星级最大等级说明</b></p>
                <p>1★：30</p>
                <p>2★：30</p>
                <p>3★：40/55</p>
                <p>4★：45/60/70</p>
                <p>5★：50/70/80</p>
                <p>6★：50/80/90</p>
            </div>
            <div class="col-12 col-sm-6 text-left">
                <p><b>各等级经验书说明：</b></p>
                <p>基础：200</p>
                <p>初级：400</p>
                <p>中级：1000</p>
                <p>高级：2000</p>
            </div>
        </div>
    </div>

    <hr />
    <div class="row col-12 page-footer">
        <div class="col-12 text-center">
            <p>最近更新：2019/05/05，<a href="https://bbs.nga.cn/read.php?tid=16971344">联系作者</a></p>
            <p>
                数据来源：
                <a href="https://ak.hypergryph.com">『明日方舟』</a>
            </p>
            <p>Powered by 一只灰猫。</p>

        </div>
    </div>
    <script>
        $(function () {
            let maxLevel = [];
            let charExpMap = [];
            let charUpCostMap = [];
            let evolveGoldCost = [];
            $.getJSON("aklevel.json", function (data) {
                maxLevel = data['maxLevel'];
                charExpMap = data['characterExpMap'];
                charUpCostMap = data['characterUpgradeCostMap'];
                evolveGoldCost = data['evolveGoldCost'];
            });
            $("#star").change(function () {
                let star = $(this).val();
                let maxEvolve = maxLevel[star - 1].length;
                $("#current-evolve").html("");
                $("#target-evolve").html("");
                for (let i = 0; i < maxEvolve; i++) {
                    $("#current-evolve").append("<option>" + i + "</option>");
                    $("#target-evolve").append("<option>" + i + "</option>");
                }
                $("#current-evolve").val(0);
                $("#target-evolve").val(0);
            });
            $(document).on('click', '#btn-calculate', function () {
                $("#error-info").hide();
                $("#tbody-result").html("");
                let star = parseInt($("#star").val());
                let cev = parseInt($("#current-evolve").val());
                let cl = parseInt($("#current-level").val());
                let ce = parseInt($("#current-exp").val());
                let te = parseInt($("#target-evolve").val());
                let tl = parseInt($("#target-level").val());
                let ga = parseInt($("#gold-asset").val());
                let bb = parseInt($("#book-basic").val());
                let bp = parseInt($("#book-primary").val());
                let bm = parseInt($("#book-middle").val());
                let ba = parseInt($("#book-advanced").val());
                if (isNaN(cl) || isNaN(tl)) {
                    $("#error-info").html("等级必须为1~90的数字。");
                    $("#error-info").show();
                    return;
                }
                if (isNaN(ga) || isNaN(bb) || isNaN(bp) || isNaN(bm) || isNaN(ba)) {
                    $("#error-info").html("已有金币/经验书数量只能为数字。");
                    $("#error-info").show();
                    return;

                }
                if (te < cev || (te === cev && tl <= cl)) {
                    $("#error-info").html("目标等级不能低于或等于当前等级。");
                    $("#error-info").show();
                    return;
                }
                if (cl > maxLevel[star - 1][cev] || tl > maxLevel[star - 1][te]) {
                    $("#error-info").html("等级超出精英化阶段范围。");
                    $("#error-info").show();
                    return;
                }
                if (isNaN(ce) || ce < 0) {
                    $("#error-info").html("当前经验必须为正整数");
                    $("#error-info").show();
                    return;
                } else if ((cl === maxLevel[star - 1][cev] && ce !== 0) || ((cl !== maxLevel[star - 1][cev] && ce >= charExpMap[cev][cl - 1]))) {
                    $("#error-info").html("当前经验超出可能的范围，请检查输入。");
                    $("#error-info").show();
                    return;
                }
                let es = cl === maxLevel[star - 1][cev] ? 0 : charExpMap[cev][cl - 1] - ce;
                let cs = cl === maxLevel[star - 1][cev] ? 0 : charUpCostMap[cev][cl - 1] * es / (charExpMap[cev][cl - 1]);
                cl++;
                for (let i = cev, j = cl; i <= te; i++) {
                    while (i < te && j < maxLevel[star - 1][i]) {
                        es += charExpMap[i][j - 1];
                        cs += charUpCostMap[i][j - 1];
                        j++;
                    }
                    while (i === te && j < tl) {
                        es += charExpMap[i][j - 1];
                        cs += charUpCostMap[i][j - 1];
                        j++;
                    }
                    j = 1;
                }
                let ea = 0;
                for (let i = cev; i < te; i++) {
                    //console.log(star - 1);
                    //console.log(cev);
                    console.log(evolveGoldCost[star - 1][i]);
                    ea += evolveGoldCost[star - 1][i];
                }
                let bs = bb * 200 + bp * 400 + bm * 1000 + ba * 2000;
                let eb = es - bs;
                if (eb < 0) eb = 0;
                let gs = (cs + ea).toFixed(1);
                let gn = gs - ga;
                if (gn < 0) gn = 0;
                let lsn = Math.ceil((eb / 7500).toFixed(1));
                let cen = Math.ceil((gn / 7500).toFixed(1));
                $.each([
                    ['体力总计', "<b>" + (lsn + cen) * 30 + "</b> <sub>= " + lsn * 30 + " + " + cen * 30 + "</sub>"],
                    ['经验', "<b>" + eb + "</b> <sub>= " + es + " - " + bs + "</sub>"],
                    ['LS体力 <sub>场数</sub>', "<b>" + lsn * 30 + "</b> <sub>= 30 * " + lsn + "</sub>"],
                    ['金币', "<b>" + gn + "</b> <sub>= " + gs + " - " + ga + "</sub>"],
                    ['CE体力 <sub>场数</sub>', "<b>" + cen * 30 + "</b> <sub>= 30 * " + cen + "</sub>"],
                    ['升级金币', cs.toFixed(1)],
                    ['精英化金币', ea],
                ], function (_, v) {
                    $("#tbody-result").append('<tr><th scope="row" class="text-right">' + v[0] + '</th><td>' + v[1] + '</td></tr>');
                });
            });
        });
    </script>
</body>
</html>